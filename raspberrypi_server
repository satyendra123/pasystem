from flask import Flask, request, jsonify
from gtts import gTTS
import pygame
import os

app = Flask(__name__)

# Define your speaker ID here
EXPECTED_ID = 'speaker1'

# Initialize Pygame mixer
pygame.mixer.init()

@app.route('/send-message', methods=['POST'])
def receive_message():
    data = request.json
    speaker_id = data.get('id')
    message = data.get('msg')

    if not speaker_id or not message:
        return jsonify({'status': 'error', 'message': 'ID and message are required'}), 400

    # Check if the received speaker ID matches the expected ID
    if speaker_id != EXPECTED_ID:
        return jsonify({'status': 'error', 'message': 'Invalid speaker ID'}), 400

    # Convert text to speech
    tts = gTTS(text=message, lang='en')
    audio_file = 'message.mp3'
    tts.save(audio_file)

    # Play the audio file
    try:
        pygame.mixer.music.load(audio_file)
        pygame.mixer.music.play()
        while pygame.mixer.music.get_busy():  # Wait for the music to finish playing
            pygame.time.Clock().tick(10)
        os.remove(audio_file)  # Clean up by removing the file
    except Exception as e:
        print(f'Error playing audio: {e}')
        return jsonify({'status': 'error', 'message': 'Error playing audio'}), 500

    return jsonify({'status': 'success', 'message': 'Message received and played'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
